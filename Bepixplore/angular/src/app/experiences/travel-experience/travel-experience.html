<div class="experience-container">
  
  <button class="btn btn-outline-secondary mb-4" (click)="goBack()">
    ‚¨Ö Volver
  </button>

  <div class="mb-5">
    <h1 class="page-title">{{ city?.name | uppercase }}</h1>
    <p class="page-subtitle">{{ city?.country }} ‚Ä¢ Poblaci√≥n: {{ city?.population | number }}</p>
  </div>

  <div class="experience-layout">
    
    <div class="content-column">
      
      <div class="toolbar mb-4">
        <h3 class="fw-bold m-0 section-title">Opiniones de la comunidad</h3>

        <div class="search-wrapper">
          <span class="search-icon"><i class="fa fa-search"></i></span>
          <input type="text" class="form-control search-input"
                placeholder="Filtrar rese√±as..."
                [(ngModel)]="keyword" (input)="getExperiences()">
        </div>
      </div>

      <div class="filters-group mb-4">
        <button class="btn btn-sm btn-pill border"
                [ngClass]="selectedRating === null ? 'btn-dark' : 'btn-light'"
                (click)="selectedRating = null; getExperiences()">
          Todas
        </button>
        <button class="btn btn-sm btn-pill border"
                [ngClass]="selectedRating === 1 ? 'btn-success' : 'btn-light'"
                (click)="selectedRating = 1; getExperiences()">
          <i class="fa fa-thumbs-up me-1"></i> Positivas
        </button>
        <button class="btn btn-sm btn-pill border"
                [ngClass]="selectedRating === 2 ? 'btn-warning' : 'btn-light'"
                (click)="selectedRating = 2; getExperiences()">
          <i class="fa fa-info-circle me-1"></i> Neutrales
        </button>
        <button class="btn btn-sm btn-pill border"
                [ngClass]="selectedRating === 3 ? 'btn-danger' : 'btn-light'"
                (click)="selectedRating = 3; getExperiences()">
          <i class="fa fa-thumbs-down me-1"></i> Negativas
        </button>
      </div>

      @if (experiences.length === 0) {
        <div class="global-card bg-light text-center p-5 border shadow-none">
          <i class="fa fa-comments fa-3x text-secondary mb-3"></i>
          <p class="h5">No se encontraron rese√±as para "{{ keyword || city?.name }}".</p>
        </div>
      }

      @for (exp of experiences; track exp.id) {
        <div class="global-card border-0 shadow-sm mb-3 rounded-lg review-card">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
              
              <span class="badge-subtle btn-pill"
                    [ngClass]="{
                      'subtle-success': exp.rating === 1,
                      'subtle-warning': exp.rating === 2,
                      'subtle-danger': exp.rating === 3
                    }">
                <i class="fa me-1" [ngClass]="exp.rating === 1 ? 'fa-thumbs-up' : 'fa-info-circle'"></i>
                {{ exp.rating === 1 ? 'Recomendado' : exp.rating === 2 ? 'Neutral' : 'No recomendado' }}
              </span>

              <div class="text-end">
                <small class="text-muted d-block mb-1">{{ exp.travelDate | date:'mediumDate' }}</small>
                
                @if (exp.userId === currentUserId) {
                  <div class="action-buttons">
                    <button class="btn btn-sm btn-icon-only text-primary" (click)="prepareEdit(exp)" title="Editar">
                      <i class="fa fa-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-icon-only text-danger" (click)="deleteExperience(exp.id)" title="Eliminar">
                      <i class="fa fa-trash"></i>
                    </button>
                  </div>
                }
              </div>
            </div>
            <p class="card-text mb-0">"{{ exp.description }}"</p>
          </div>
        </div>
      }

    </div>

    <div class="sidebar-column">
      <div class="global-card border-0 shadow-sm rounded-lg p-3 sticky-sidebar">
        <h4 class="fw-bold mb-4">
          {{ isEditing ? 'Editar tu experiencia' : 'Cu√©ntanos tu experiencia' }}
        </h4>

        <div class="mb-3">
          <label class="form-label small fw-bold">VALORACI√ìN</label>
          <select class="form-select border-0 bg-light" [(ngModel)]="newReview.rating">
            <option [ngValue]="1">‚≠ê Positiva</option>
            <option [ngValue]="2">üòê Neutral</option>
            <option [ngValue]="3">üòû Negativa</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label small fw-bold">TU EXPERIENCIA</label>
          <textarea class="form-control border-0 bg-light" rows="4"
                    placeholder="¬øC√≥mo fue tu viaje?" [(ngModel)]="newReview.description"></textarea>
        </div>

        <button class="btn w-100 py-2 btn-pill"
                [ngClass]="isEditing ? 'btn-info' : 'btn-dark'"
                [disabled]="!newReview.description"
                (click)="saveReview()">
          <i class="fa me-2" [ngClass]="isEditing ? 'fa-save' : 'fa-paper-plane'"></i>
          {{ isEditing ? 'Guardar cambios' : 'Publicar experiencia' }}
        </button>

        @if (isEditing) {
          <button class="btn btn-link btn-sm w-100 mt-2 text-secondary decoration-none" (click)="resetForm()">
            Cancelar edici√≥n
          </button>
        }
      </div>
    </div>

  </div>
</div>